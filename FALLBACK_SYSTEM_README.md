# フォールバックシステム実装

## 概要

オフライン機能が使えなくてもシステムが問題なく動くように、堅牢なフォールバック機能を実装しました。これにより、IndexedDBが利用できない環境や、オフライン機能に問題がある場合でも、システムは正常に動作し続けます。

## 実装した機能

### 1. フォールバックマネージャー (`fallback-manager.js`)

オフライン機能の可用性を自動的に検出し、問題がある場合は直接サーバーとの通信にフォールバックします。

#### 主要機能:
- **自動検出**: オフライン機能（IndexedDB等）の可用性を自動検出
- **フォールバック**: オフライン機能が使えない場合は直接サーバー通信
- **リトライ機能**: 通信失敗時の自動リトライ（最大3回）
- **エラー追跡**: オフライン機能のエラー数を追跡し、閾値を超えたらフォールバックモードに移行

#### 対応操作:
- `getSeatsData()`: 座席データの取得
- `reserveSeat()`: 座席予約
- `checkinSeat()`: チェックイン
- `issueWalkinTicket()`: 当日券発行
- `adminEditSeat()`: 管理者編集

### 2. システムステータス表示 (`system-status.js`)

システムの状態を視覚的に表示し、ユーザーに適切な情報を提供します。

#### 主要機能:
- **リアルタイム表示**: システムの状態をリアルタイムで表示
- **通知システム**: 重要な状態変化をユーザーに通知
- **キーボードショートカット**: デバッグ用のショートカットキー
- **詳細情報**: システムの詳細状態をコンソールに出力

#### 表示状態:
- 🟢 **オンライン**: 正常動作
- 🟠 **オフライン**: オフライン機能使用中
- 🟠 **フォールバックモード**: オフライン機能無効、直接サーバー通信
- 🔴 **オフライン機能無効**: オフライン機能が利用不可

#### キーボードショートカット:
- `Ctrl+Shift+S`: 詳細ステータス表示
- `Ctrl+Shift+F`: フォールバックモード切り替え
- `Ctrl+Shift+R`: オフライン機能再試行

### 3. 強化されたエラーハンドリング (`error-handler-enhanced.js`)

ユーザーフレンドリーなエラー処理と詳細なエラーログを提供します。

#### 主要機能:
- **エラー分類**: エラーの種類を自動分類
- **ユーザーフレンドリー**: 技術的なエラーを分かりやすいメッセージに変換
- **エラー追跡**: エラーの発生頻度を追跡
- **自動復旧**: 過度なエラー発生時の自動フォールバック

#### 対応エラー:
- **NetworkError**: ネットワーク接続エラー
- **QuotaExceededError**: ストレージ容量不足
- **TimeoutError**: タイムアウトエラー
- **PermissionError**: 権限エラー
- **ValidationError**: 入力検証エラー
- **ServerError**: サーバーエラー
- **OfflineError**: オフライン機能エラー

## 使用方法

### 1. 自動フォールバック

システムは自動的にオフライン機能の可用性を検出し、問題がある場合はフォールバックモードに移行します。ユーザーは特別な操作を行う必要はありません。

```javascript
// 自動的にフォールバック対応
const seatData = await fallbackManager.getSeatsData(group, day, timeslot);
```

### 2. 手動フォールバック制御

必要に応じて、フォールバックモードを手動で制御できます。

```javascript
// フォールバックモードを有効化
fallbackManager.enableFallbackMode();

// フォールバックモードを無効化
fallbackManager.disableFallbackMode();

// オフライン機能を再試行
await fallbackManager.retryOfflineFunctionality();
```

### 3. システム状態の確認

```javascript
// システム状態を取得
const stats = fallbackManager.getStats();
console.log('フォールバックモード:', stats.fallbackMode);
console.log('オフライン機能利用可能:', stats.isOfflineAvailable);

// エラー統計を取得
const errorStats = errorHandler.getErrorStatistics();
console.log('エラー統計:', errorStats);
```

## 動作フロー

### 1. 正常動作時
```
ユーザー操作 → オフライン機能 → ローカル/サーバー → 結果表示
```

### 2. オフライン機能エラー時
```
ユーザー操作 → オフライン機能（エラー） → フォールバック → 直接サーバー → 結果表示
```

### 3. フォールバックモード時
```
ユーザー操作 → 直接サーバー → 結果表示
```

## エラー処理の流れ

1. **エラー発生**: オフライン機能でエラーが発生
2. **エラー分類**: エラーの種類を自動分類
3. **ユーザー通知**: 分かりやすいメッセージでユーザーに通知
4. **エラー追跡**: エラー数をカウント
5. **フォールバック判定**: エラー数が閾値を超えたらフォールバックモードに移行
6. **自動復旧**: 一定時間後にオフライン機能の再試行

## 設定可能なパラメータ

### フォールバックマネージャー
- `maxOfflineErrors`: フォールバック移行までの最大エラー数（デフォルト: 3）
- `retryDelay`: リトライ間隔（デフォルト: 1000ms）
- `maxRetries`: 最大リトライ回数（デフォルト: 3）

### エラーハンドラー
- `maxErrorsPerOperation`: 操作あたりの最大エラー数（デフォルト: 3）
- `errorResetTime`: エラーカウントリセット時間（デフォルト: 60000ms）

## トラブルシューティング

### 1. オフライン機能が動作しない
- ブラウザの設定を確認（プライベートブラウジングモードを無効化）
- ストレージ容量を確認
- フォールバックモードが自動的に有効化されます

### 2. フォールバックモードが有効にならない
- ネットワーク接続を確認
- サーバーの状態を確認
- 手動でフォールバックモードを有効化

### 3. エラーが多発する
- ブラウザのキャッシュをクリア
- ページを再読み込み
- エラーレポートを生成して確認

## デバッグ機能

### 1. コンソールコマンド
```javascript
// システム状態を確認
fallbackManager.getStats();

// エラー統計を確認
errorHandler.getErrorStatistics();

// エラーレポートを生成
errorHandler.generateErrorReport();

// フォールバックモードを切り替え
fallbackManager.toggleFallbackMode();
```

### 2. キーボードショートカット
- `Ctrl+Shift+S`: 詳細ステータス表示
- `Ctrl+Shift+F`: フォールバックモード切り替え
- `Ctrl+Shift+R`: オフライン機能再試行

## パフォーマンス向上

### 1. 自動最適化
- オフライン機能の可用性に応じた自動切り替え
- エラー発生時の自動フォールバック
- リトライ機能による信頼性向上

### 2. ユーザー体験の向上
- 分かりやすいエラーメッセージ
- リアルタイムな状態表示
- 自動復旧機能

## 今後の拡張

1. **詳細なメトリクス**: パフォーマンス指標の収集
2. **自動診断**: システムの問題を自動診断
3. **設定UI**: ユーザーが設定を変更できるUI
4. **ログ分析**: エラーログの分析機能

## 注意事項

1. **ブラウザ対応**: モダンブラウザでの動作を前提としています
2. **ネットワーク依存**: フォールバックモードではネットワーク接続が必要です
3. **データ整合性**: オフライン機能とフォールバックモード間でのデータ整合性に注意が必要です
4. **パフォーマンス**: フォールバックモードでは直接サーバー通信のため、若干の遅延が発生する可能性があります
